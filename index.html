<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>دراسات الجدوى المتكاملة - Rady Mehany</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --rm-blue:#1e40af; }
    body { font-family:'Tajawal',sans-serif; background:#ffffff; color:#111827; }
    .project-btn { padding:.75rem 1.5rem; font-size:1.125rem; font-weight:800; border-radius:.75rem; box-shadow:0 4px 12px rgba(0,0,0,.08); transition:transform .25s ease, box-shadow .25s ease; background:#e5e7eb; color:#111827; }
    .project-btn:hover{ transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.12); }
    .project-btn.active{ background:var(--rm-blue); color:#fff; }
    input[type="number"], input[type="text"]{ text-align:center; font-weight:700; }
    .input-field{ margin-top:.25rem; width:100%; padding:.5rem; border:1px solid #d1d5db; border-radius:.5rem; background:#fff; }
    .calculated-field{ margin-top:.25rem; width:100%; padding:.5rem; border:1px solid #d1d5db; border-radius:.5rem; background:#eef2ff; text-align:center; font-weight:800; font-size:1.125rem; }
    .calculator-inputs{ display:none; }
    .calculator-inputs.active{ display:block; }
    .result-value { font-size:1.5rem; font-weight:800; }
    /* ✅ طباعة كاملة للتقرير */
    @media print {
      body { background:#ffffff !important; color:#000 !important; font-size:10pt; margin:0; }
      .no-print { display:none !important; }
      main { display:block !important; }
      aside { width:100% !important; position:static !important; box-shadow:none !important; border:none !important; page-break-inside:avoid; }
      .result-box { background:#ffffff !important; border:1px solid #000 !important; padding:.35rem; margin-bottom:.5rem !important; }
      .result-box h3 { font-size:1rem; margin:0 0 .1rem; }
      .result-value { font-size:1.25rem; }
      #print-header { margin-bottom:.5rem !important; }
      #print-header h1 { text-align:center; font-size:1.3rem; }
      #print-header p { text-align:center; font-size:.9rem; }
      #print-summary { display:block !important; }
      .print-table { width:100%; border-collapse:collapse; margin-top:.5rem; }
      .print-table td { border:1px solid #c7c7c7; padding:5px 6px; }
      .print-table tr td:last-child { font-weight:700; text-align:left; white-space:nowrap; }
      #print-footer { display:block !important; position:fixed; bottom:10px; left:0; right:0; text-align:center; font-size:9pt; color:#6b7280; }
    }
  </style>
</head>
<body class="bg-white text-gray-900">
  <div class="container mx-auto p-4">
    <header class="text-center mb-4 pt-4 no-print">
      <h1 id="main-title" class="text-3xl sm:text-4xl font-extrabold text-gray-900"></h1>
      <p class="text-lg text-gray-600 mt-2">مقدمة من / Rady Mehany</p>
      <div class="my-8 flex justify-center flex-wrap gap-4">
        <button id="btn-delivery" class="project-btn">🚀 التوصيل</button>
        <button id="btn-cleaning" class="project-btn">💧 النظافة</button>
        <button id="btn-setup" class="project-btn">🏗️ تكاليف التأسيس</button>
      </div>
      <div class="text-center my-6">
        <button onclick="window.print()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 shadow-lg">🖨️ طباعة التقرير</button>
      </div>
    </header>

    <!-- رأس الطباعة -->
    <div id="print-header" class="hidden print:block mb-8">
      <h1 class="text-2xl font-bold">تقرير دراسة الجدوى المالية</h1>
      <p id="print-date" class="text-sm text-gray-600"></p>
    </div>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-2 space-y-6 no-print">
        <div id="delivery-inputs" class="calculator-inputs space-y-6"></div>
        <div id="cleaning-inputs" class="calculator-inputs space-y-6"></div>
        <div id="setup-inputs" class="calculator-inputs space-y-6"></div>
      </div>

      <!-- ✅ نطبع الخلاصة في التقرير -->
      <aside class="lg:col-span-1">
        <div class="bg-white p-6 rounded-xl shadow-lg border-2 border-gray-200 lg:sticky top-8">
          <h2 id="sidebar-title" class="text-2xl font-extrabold text-center mb-6"></h2>
          <div id="monthly-results" class="space-y-4">
            <div class="p-4 bg-blue-50 rounded-lg text-center result-box">
              <h3 class="text-lg font-bold text-blue-800">إجمالي الإيرادات</h3>
              <p id="totalRevenue" class="result-value text-blue-700">0 د.ك</p>
            </div>
            <div class="p-4 bg-red-50 rounded-lg text-center result-box">
              <h3 class="text-lg font-bold text-red-800">إجمالي التكاليف الشهرية</h3>
              <p id="totalCosts" class="result-value text-red-700">0 د.ك</p>
            </div>
            <div class="p-4 bg-indigo-100 rounded-lg text-center border-2 border-indigo-200 result-box">
              <h3 class="text-xl font-extrabold text-indigo-900">صافي الربح التشغيلي</h3>
              <p id="operatingProfit" class="result-value text-indigo-700" style="font-size:2rem">0 د.ك</p>
            </div>
          </div>

          <div id="setup-costs-result-box" class="p-4 bg-green-100 rounded-lg text-center mt-4 border-2 border-green-200">
            <h3 class="text-xl font-bold text-green-800">تكاليف التأسيس (تدفع مرة واحدة)</h3>
            <p id="totalSetupCosts" class="text-3xl font-extrabold text-green-700 mt-2">0 د.ك</p>
          </div>

          <div id="kpi-section" class="mt-6 pt-6 border-t border-gray-200 space-y-3 text-center">
            <h4 class="font-bold text-lg mb-2">مؤشرات الأداء الرئيسية</h4>
            <div><strong>هامش الربح:</strong> <span id="kpiProfitMargin" class="font-bold text-green-600 text-lg">0%</span></div>
            <div><strong id="kpiUnitLabel"></strong> <span id="kpiRevenuePerUnit" class="font-bold text-blue-600 text-lg">0 د.ك</span></div>
            <div><strong id="kpiProfitLabel"></strong> <span id="kpiProfitPerUnit" class="font-bold text-indigo-600 text-lg">0 د.ك</span></div>
          </div>

          <hr id="details-hr" class="my-4" />

          <div id="details-section" class="space-y-2 text-sm text-center">
            <h4 class="font-bold text-lg mb-2">تفاصيل سريعة</h4>
            <p><strong>التكاليف الثابتة:</strong> <span id="detailFixed" class="font-bold text-base">0 د.ك</span></p>
            <p><strong>تكاليف متغيرة:</strong> <span id="detailVariable" class="font-bold text-base">0 د.ك</span></p>
            <p><strong id="detailUnitLabel"></strong> <span id="detailUnits" class="font-bold text-base">0</span></p>
          </div>

          <!-- ملخص الطباعة -->
          <div id="print-summary" class="hidden"></div>
        </div>
      </aside>
    </main>

    <footer id="print-footer" class="hidden">Prepared by: Eng. Rady Mahany | © 2025</footer>
  </div>

  <script>
    // --- GLOBAL STATE ---
    let currentCalculator = '';
    let totalSetupCost = 0;

    const formatCurrency = (num) => `${Number(num||0).toLocaleString('en-US',{maximumFractionDigits:0})} د.ك`;
    const parseInput = (id) => parseFloat(document.getElementById(id)?.value) || 0;

    // --- TEMPLATES ---
    const deliveryInputsHTML = `
      <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
        <h2 class="text-xl font-bold mb-4">المدخلات الأساسية للمشروع</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="d_companies" class="block text-sm font-medium">عدد شركات التوصيل</label>
            <input type="number" id="d_companies" value="8" class="input-field" />
          </div>
          <div>
            <label for="d_officeRent" class="block text-sm font-medium">إيجار المكتب (للشركة)</label>
            <input type="number" id="d_officeRent" value="250" class="input-field" />
          </div>
          <div class="md:col-span-2">
            <label for="d_adminStaffCount" class="block text-sm font-medium">عدد الإداريين (الإجمالي)</label>
            <input type="number" id="d_adminStaffCount" value="21" class="input-field" />
          </div>
        </div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
        <h2 class="text-xl font-bold mb-4">مدخلات الأسطول (للشركة الواحدة)</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="p-4 bg-gray-100 rounded-lg space-y-2">
            <h3 class="font-bold">السيارات</h3>
            <label>عدد السيارات</label><input type="number" id="d_carsPerCompany" value="70" class="input-field" />
            <label>راتب السائق</label><input type="number" id="d_carDriverSalary" value="150" class="input-field" />
            <label>سكن</label><input type="number" id="d_carHousing" value="20" class="input-field" />
            <label>بنزين</label><input type="number" id="d_carFuel" value="50" class="input-field" />
            <label>قسط السيارة</label><input type="number" id="d_carInstallment" value="180" class="input-field" />
            <label>تأمين السيارة</label><input type="number" id="d_carInsurance" value="15" class="input-field" />
          </div>
          <div class="p-4 bg-gray-100 rounded-lg space-y-2">
            <h3 class="font-bold">السياكل</h3>
            <label>عدد السياكل</label><input type="number" id="d_bikesPerCompany" value="20" class="input-field" />
            <label>راتب السائق</label><input type="number" id="d_bikeRiderSalary" value="150" class="input-field" />
            <label>سكن</label><input type="number" id="d_bikeHousing" value="20" class="input-field" />
            <label>بنزين</label><input type="number" id="d_bikeFuel" value="20" class="input-field" />
            <label>قسط السيكل</label><input type="number" id="d_bikeInstallment" value="60" class="input-field" />
          </div>
        </div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
        <h2 class="text-xl font-bold mb-4">مدخلات الإيرادات</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="d_avgOrders" class="block text-sm font-medium">الطلبات الشهرية (للسائق)</label>
            <input type="number" id="d_avgOrders" value="400" class="input-field" />
          </div>
          <div>
            <label for="d_avgOrderPrice" class="block text-sm font-medium">متوسط سعر الطلب (د.ك)</label>
            <input type="number" id="d_avgOrderPrice" step="0.05" value="1.35" class="input-field" />
          </div>
        </div>
      </div>`;

    const cleaningInputsHTML = `
      <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
        <h2 class="text-xl font-bold mb-4">المدخلات الأساسية للمشروع</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="c_officeRent" class="block text-sm font-medium">إيجار المكتب والمخزن</label>
            <input type="number" id="c_officeRent" value="300" class="input-field" />
          </div>
          <div>
            <label for="c_housingRent" class="block textsm font-medium">إيجار سكن الموظفات</label>
            <input type="number" id="c_housingRent" value="500" class="input-field" />
          </div>
          <div class="md:col-span-2">
            <label for="c_adminStaffCount" class="block text-sm font-medium">عدد المشرفين والإداريين</label>
            <input type="number" id="c_adminStaffCount" value="4" class="input-field" />
          </div>
        </div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
        <h2 class="text-xl font-bold mb-4">مدخلات العاملين والسائقين</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="p-4 bg-gray-100 rounded-lg space-y-2">
            <h3 class="font-bold">الموظفات</h3>
            <label>عدد الموظفات</label><input type="number" id="c_employeeCount" value="10" class="input-field" />
            <label>راتب الموظفة</label><input type="number" id="c_employeeSalary" value="180" class="input-field" />
            <label>بدل طعام</label><input type="number" id="c_foodAllowance" value="20" class="input-field" />
            <label>مواد ومعدات</label><input type="number" id="c_materials" value="40" class="input-field" />
            <label>تأمين على الحياة</label><input type="number" id="c_lifeInsurance" value="10" class="input-field" />
          </div>
          <div class="p-4 bg-gray-100 rounded-lg space-y-2">
            <h3 class="font-bold">سائقين الخدمة</h3>
            <label>عدد السائقين (محسوب تلقائياً)</label><div id="c_driverCount_display" class="calculated-field">0</div>
            <label>راتب السائق</label><input type="number" id="c_driverSalary" value="160" class="input-field" />
            <label>سكن السائق</label><input type="number" id="c_driverHousing" value="20" class="input-field" />
            <label>وقود المركبة</label><input type="number" id="c_driverFuel" value="50" class="input-field" />
            <label>قسط المركبة</label><input type="number" id="c_driverInstallment" value="180" class="input-field" />
          </div>
        </div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
        <h2 class="text-xl font-bold mb-4">مدخلات الإيرادات</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="c_avgVisits" class="block text-sm font-medium">الزيارات الشهرية (للموظفة)</label>
            <input type="number" id="c_avgVisits" value="25" class="input-field" />
          </div>
          <div>
            <label for="c_avgVisitPrice" class="block text-sm font-medium">متوسط سعر الزيارة (د.ك)</label>
            <input type="number" id="c_avgVisitPrice" step="1" value="15" class="input-field" />
          </div>
        </div>
      </div>`;

    const setupInputsHTML = `
      <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
        <h2 class="text-xl font-bold mb-4">1. مصاريف جلب عاملة</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-3">
          <div><label>إصدار</label><input type="number" id="cost_isdar" value="9" class="input-field recruitment-cost" /></div>
          <div><label>تصريح</label><input type="number" id="cost_tasreeh" value="0" class="input-field recruitment-cost" /></div>
          <div><label>إذن عمل</label><input type="number" id="cost_work_permit" value="150" class="input-field recruitment-cost" /></div>
          <div><label>كشف طبي</label><input type="number" id="cost_medical" value="10" class="input-field recruitment-cost" /></div>
          <div><label>بصمات</label><input type="number" id="cost_fingerprint" value="0" class="input-field recruitment-cost" /></div>
          <div><label>ضمان صحي</label><input type="number" id="cost_health_insurance" value="50" class="input-field recruitment-cost" /></div>
          <div><label>اقامة</label><input type="number" id="cost_residency" value="10" class="input-field recruitment-cost" /></div>
          <div><label>فصيلة دم</label><input type="number" id="cost_blood_type" value="1.5" class="input-field recruitment-cost" /></div>
          <div><label>بطاقة مدنية</label><input type="number" id="cost_civil_id" value="5" class="input-field recruitment-cost" /></div>
          <div><label>مصاريف بنك</label><input type="number" id="cost_bank" value="17" class="input-field recruitment-cost" /></div>
          <div><label>كرت صحة</label><input type="number" id="cost_health_card" value="17" class="input-field recruitment-cost" /></div>
          <div><label>تذكرة ذهاب</label><input type="number" id="cost_ticket_oneway" value="120" class="input-field recruitment-cost" /></div>
          <div><label>تذكرة عودة</label><input type="number" id="cost_ticket_return" value="120" class="input-field recruitment-cost" /></div>
        </div>
        <div class="mt-4 p-4 bg-gray-100 rounded-lg">
          <label class="block text-center font-bold">عدد الموظفات لحساب التكلفة</label>
          <input type="number" id="employee_count_total" value="10" class="input-field w-full p-2 text-xl font-bold rounded mt-2" />
        </div>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
        <h2 class="text-xl font-bold mb-4">2. تكاليف المعدات</h2>
        <table class="w-full">
          <thead>
            <tr>
              <th class="p-2 bg-gray-200">المعدة</th>
              <th class="p-2 bg-gray-200">النوع</th>
              <th class="p-2 bg-gray-200">السعر (د.ك)</th>
            </tr>
          </thead>
          <tbody id="equipment-table-body"></tbody>
        </table>
        <button id="add-row-btn" class="mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700">+ إضافة صف</button>
      </div>`;

    // --- UI ---
    function activateButton(type){ const map = { delivery:'btn-delivery', cleaning:'btn-cleaning', setup:'btn-setup' }; Object.keys(map).forEach(k=>{ const el=document.getElementById(map[k]); if(!el) return; el.classList.toggle('active', k===type); }); }
    function switchCalculator(type){ if(currentCalculator===type) return; currentCalculator=type; activateButton(type); const inputs={delivery:'delivery-inputs',cleaning:'cleaning-inputs',setup:'setup-inputs'}; Object.keys(inputs).forEach(k=>document.getElementById(inputs[k]).classList.toggle('active',k===type)); const titles={delivery:'دراسة الجدوى لشركات التوصيل',cleaning:'دراسة الجدوى لشركات النظافة',setup:'حاسبة تكاليف التأسيس'}; document.getElementById('main-title').textContent=titles[type]; document.getElementById('sidebar-title').textContent=(type==='setup')?'خلاصة تكاليف التأسيس':'الخلاصة المالية الشهرية'; const showMonthly=(type==='delivery'||type==='cleaning'); document.getElementById('monthly-results').style.display=showMonthly?'block':'none'; document.getElementById('kpi-section').style.display=showMonthly?'block':'none'; document.getElementById('details-section').style.display=showMonthly?'block':'none'; document.getElementById('details-hr').style.display=showMonthly?'block':'none'; document.getElementById('setup-costs-result-box').style.display='block'; run(); }
    function run(){ if(currentCalculator==='delivery') runDelivery(); else if(currentCalculator==='cleaning') runCleaning(); else if(currentCalculator==='setup') runSetup(); const pd=document.getElementById('print-date'); if(pd){ pd.textContent=`تاريخ الطباعة: ${new Date().toLocaleDateString('ar-EG-u-nu-latn',{year:'numeric',month:'long',day:'numeric'})}`; } }

    // --- DELIVERY ---
    function getDeliveryInputs(){ return { companies:parseInput('d_companies'), officeRent:parseInput('d_officeRent'), adminStaffCount:parseInput('d_adminStaffCount'), carsPerCompany:parseInput('d_carsPerCompany'), carDriverSalary:parseInput('d_carDriverSalary'), carHousing:parseInput('d_carHousing'), carFuel:parseInput('d_carFuel'), carInstallment:parseInput('d_carInstallment'), carInsurance:parseInput('d_carInsurance'), bikesPerCompany:parseInput('d_bikesPerCompany'), bikeRiderSalary:parseInput('d_bikeRiderSalary'), bikeHousing:parseInput('d_bikeHousing'), bikeFuel:parseInput('d_bikeFuel'), bikeInstallment:parseInput('d_bikeInstallment'), avgOrders:parseInput('d_avgOrders'), avgOrderPrice:parseInput('d_avgOrderPrice') }; }
    function runDelivery(){ const V=getDeliveryInputs(); const adminSalary=V.adminStaffCount*250; const fixedCosts=(V.officeRent*V.companies)+adminSalary; const totalCars=V.companies*V.carsPerCompany; const totalBikes=V.companies*V.bikesPerCompany; const totalUnits=totalCars+totalBikes; const carCosts=totalCars*(V.carDriverSalary+V.carHousing+V.carFuel+V.carInstallment+V.carInsurance); const bikeCosts=totalBikes*(V.bikeRiderSalary+V.bikeHousing+V.bikeFuel+V.bikeInstallment); const variableCosts=carCosts+bikeCosts; const totalCosts=fixedCosts+variableCosts; const totalRevenue=totalUnits*V.avgOrders*V.avgOrderPrice; const operatingProfit=totalRevenue-totalCosts; const profitMargin= totalRevenue>0 ? (operatingProfit/totalRevenue)*100 : 0; const revenuePerUnit= totalUnits>0 ? totalRevenue/totalUnits : 0; const profitPerUnit= totalUnits>0 ? operatingProfit/totalUnits : 0; const data={V,totalRevenue,totalCosts,operatingProfit,profitMargin,revenuePerUnit,profitPerUnit,fixedCosts,variableCosts,totalUnits}; updateDeliveryDisplay(data); document.getElementById('print-summary').innerHTML=generateDeliveryPrintHTML(data); }
    function updateDeliveryDisplay(d){ document.getElementById('totalRevenue').textContent=formatCurrency(d.totalRevenue); document.getElementById('totalCosts').textContent=formatCurrency(d.totalCosts); document.getElementById('operatingProfit').textContent=formatCurrency(d.operatingProfit); document.getElementById('kpiProfitMargin').textContent=`${d.profitMargin.toFixed(1)}%`; document.getElementById('kpiUnitLabel').textContent='الإيراد لكل سائق:'; document.getElementById('kpiRevenuePerUnit').textContent=formatCurrency(d.revenuePerUnit); document.getElementById('kpiProfitLabel').textContent='الربح الصافي لكل سائق:'; document.getElementById('kpiProfitPerUnit').textContent=formatCurrency(d.profitPerUnit); document.getElementById('detailUnitLabel').textContent='إجمالي السائقين:'; document.getElementById('detailFixed').textContent=formatCurrency(d.fixedCosts); document.getElementById('detailVariable').textContent=formatCurrency(d.variableCosts); document.getElementById('detailUnits').textContent=d.totalUnits; document.getElementById('totalSetupCosts').textContent=formatCurrency(0); }
    function generateDeliveryPrintHTML(d){ return `<div class="mt-4"><h3 class="font-bold text-lg mb-2 text-center" style="font-size:1.1rem;">تفاصيل التكاليف</h3><table class="print-table"><tr><td colspan="2" style="background-color:#f3f4f6;font-weight:bold;">التكاليف الثابتة</td></tr><tr><td>رواتب الإداريين (${d.V.adminStaffCount} موظف)</td><td>${formatCurrency(d.V.adminStaffCount*250)}</td></tr><tr><td>إجمالي الإيجارات (${d.V.companies} مكتب)</td><td>${formatCurrency(d.V.officeRent*d.V.companies)}</td></tr><tr style="font-weight:bold;border-top:2px solid #333;"><td>إجمالي التكاليف الثابتة</td><td>${formatCurrency(d.fixedCosts)}</td></tr><tr><td colspan="2" style="background-color:#f3f4f6;font-weight:bold;padding-top:8px;">التكاليف المتغيرة</td></tr><tr><td>رواتب السائقين (${d.totalUnits} سائق)</td><td>${formatCurrency((d.V.carDriverSalary*(d.V.companies*d.V.carsPerCompany)) + (d.V.bikeRiderSalary*(d.V.companies*d.V.bikesPerCompany)))}</td></tr><tr><td>تكاليف السكن</td><td>${formatCurrency((d.V.carHousing*(d.V.companies*d.V.carsPerCompany)) + (d.V.bikeHousing*(d.V.companies*d.V.bikesPerCompany)))}</td></tr><tr><td>تكاليف الوقود</td><td>${formatCurrency((d.V.carFuel*(d.V.companies*d.V.carsPerCompany)) + (d.V.bikeFuel*(d.V.companies*d.V.bikesPerCompany)))}</td></tr><tr><td>تكاليف الأقساط</td><td>${formatCurrency((d.V.carInstallment*(d.V.companies*d.V.carsPerCompany)) + (d.V.bikeInstallment*(d.V.companies*d.V.bikesPerCompany)))}</td></tr><tr><td>تكاليف التأمين (للسيارات)</td><td>${formatCurrency(d.V.carInsurance*(d.V.companies*d.V.carsPerCompany))}</td></tr><tr style="font-weight:bold;border-top:2px solid #333;"><td>إجمالي التكاليف المتغيرة</td><td>${formatCurrency(d.variableCosts)}</td></tr></table><div style="border-top:3px double #000;margin-top:1rem;padding-top:.5rem;"><h3 class="font-bold text-lg mb-2 text-center" style="font-size:1.1rem;">افتراضات التشغيل والإيرادات</h3><p style="text-align:center;font-size:.9rem;"><strong>إجمالي السائقين:</strong> ${d.totalUnits} | <strong>متوسط الطلبات للسائق:</strong> ${d.V.avgOrders} | <strong>متوسط سعر الطلب:</strong> ${d.V.avgOrderPrice.toFixed(3)} د.ك</p></div></div>`; }

    // --- CLEANING ---
    function getCleaningInputs(){ return { officeRent:parseInput('c_officeRent'), housingRent:parseInput('c_housingRent'), adminStaffCount:parseInput('c_adminStaffCount'), employeeCount:parseInput('c_employeeCount'), employeeSalary:parseInput('c_employeeSalary'), foodAllowance:parseInput('c_foodAllowance'), materials:parseInput('c_materials'), lifeInsurance:parseInput('c_lifeInsurance'), driverSalary:parseInput('c_driverSalary'), driverHousing:parseInput('c_driverHousing'), driverFuel:parseInput('c_driverFuel'), driverInstallment:parseInput('c_driverInstallment'), avgVisits:parseInput('c_avgVisits'), avgVisitPrice:parseInput('c_avgVisitPrice') }; }
    function runCleaning(){ const V=getCleaningInputs(); const driverCount=Math.floor(V.employeeCount/5); const display=document.getElementById('c_driverCount_display'); if(display) display.textContent=driverCount; const adminSalary=V.adminStaffCount*250; const fixedCosts=V.officeRent+V.housingRent+adminSalary; const employeeCosts=V.employeeCount*(V.employeeSalary+V.foodAllowance+V.materials+V.lifeInsurance); const driverCosts=driverCount*(V.driverSalary+V.driverHousing+V.driverFuel+V.driverInstallment); const variableCosts=employeeCosts+driverCosts; const totalUnits=V.employeeCount+driverCount; const totalCosts=fixedCosts+variableCosts; const totalRevenue=V.employeeCount*V.avgVisits*V.avgVisitPrice; const operatingProfit=totalRevenue-totalCosts; const profitMargin= totalRevenue>0 ? (operatingProfit/totalRevenue)*100 : 0; const revenuePerEmployee= V.employeeCount>0 ? totalRevenue/V.employeeCount : 0; const profitPerEmployee= V.employeeCount>0 ? operatingProfit/V.employeeCount : 0; const data={V,driverCount,totalRevenue,totalCosts,operatingProfit,profitMargin,revenuePerEmployee,profitPerEmployee,fixedCosts,variableCosts,totalUnits,adminSalary,employeeCosts,driverCosts}; updateCleaningDisplay(data); document.getElementById('print-summary').innerHTML=generateCleaningPrintHTML(data); }
    function updateCleaningDisplay(d){ document.getElementById('totalRevenue').textContent=formatCurrency(d.totalRevenue); document.getElementById('totalCosts').textContent=formatCurrency(d.totalCosts); document.getElementById('operatingProfit').textContent=formatCurrency(d.operatingProfit); document.getElementById('kpiProfitMargin').textContent=`${d.profitMargin.toFixed(1)}%`; document.getElementById('kpiUnitLabel').textContent='الإيراد لكل موظفة:'; document.getElementById('kpiRevenuePerUnit').textContent=formatCurrency(d.revenuePerEmployee); document.getElementById('kpiProfitLabel').textContent='الربح الصافي لكل موظفة:'; document.getElementById('kpiProfitPerUnit').textContent=formatCurrency(d.profitPerEmployee); document.getElementById('detailUnitLabel').textContent='إجمالي العاملين:'; document.getElementById('detailFixed').textContent=formatCurrency(d.fixedCosts); document.getElementById('detailVariable').textContent=formatCurrency(d.variableCosts); document.getElementById('detailUnits').textContent=d.totalUnits; document.getElementById('totalSetupCosts').textContent=formatCurrency(totalSetupCost); }
    function generateCleaningPrintHTML(d){ return `<div class="mt-4"><h3 class="font-bold text-lg mb-2 text-center" style="font-size:1.1rem;">تفاصيل التكاليف</h3><table class="print-table"><tr><td colspan="2" style="background-color:#f3f4f6;font-weight:bold;">التكاليف الثابتة</td></tr><tr><td>رواتب الإداريين (${d.V.adminStaffCount} موظف)</td><td>${formatCurrency(d.V.adminStaffCount*250)}</td></tr><tr><td>إيجار المكتب والمخزن</td><td>${formatCurrency(d.V.officeRent)}</td></tr><tr><td>إيجار سكن الموظفات</td><td>${formatCurrency(d.V.housingRent)}</td></tr><tr style="font-weight:bold;border-top:2px solid #333;"><td>إجمالي التكاليف الثابتة</td><td>${formatCurrency(d.fixedCosts)}</td></tr><tr><td colspan="2" style="background-color:#f3f4f6;font-weight:bold;padding-top:8px;">التكاليف المتغيرة</td></tr><tr><td>تكاليف الموظفات</td><td>${formatCurrency(d.employeeCosts)}</td></tr><tr><td>تكاليف السائقين</td><td>${formatCurrency(d.driverCosts)}</td></tr><tr style="font-weight:bold;border-top:2px solid #333;"><td>إجمالي التكاليف المتغيرة</td><td>${formatCurrency(d.variableCosts)}</td></tr></table><div style="border-top:3px double #000;margin-top:1rem;padding-top:.5rem;"><h3 class="font-bold text-lg mb-2 text-center" style="font-size:1.1rem;">افتراضات التشغيل والإيرادات</h3><p style="text-align:center;font-size:.9rem;"><strong>عدد الموظفات:</strong> ${d.V.employeeCount} | <strong>عدد السائقين (محسوب):</strong> ${d.driverCount} | <strong>متوسط الزيارات للموظفة:</strong> ${d.V.avgVisits} | <strong>متوسط سعر الزيارة:</strong> ${d.V.avgVisitPrice.toFixed(0)} د.ك</p></div></div>`; }

    // --- SETUP ---
    function addEquipmentRow(){ const tableBody=document.getElementById('equipment-table-body'); const tr=document.createElement('tr'); tr.innerHTML=`<td><input type="text" class="input-field" /></td><td><input type="text" class="input-field" /></td><td><input type="number" value="0" class="input-field equipment-price" /></td>`; tableBody.appendChild(tr); tr.querySelectorAll('input').forEach(inp=>inp.addEventListener('input',run)); }
    function runSetup(){ let perWorkerCost=0; document.querySelectorAll('.recruitment-cost').forEach(input=>{ perWorkerCost += parseFloat(input.value)||0; }); const employeeCount=parseInput('employee_count_total'); const totalRecruitmentCost=perWorkerCost*employeeCount; let totalEquipmentCost=0; document.querySelectorAll('.equipment-price').forEach(input=>{ totalEquipmentCost += parseFloat(input.value)||0; }); totalSetupCost=totalRecruitmentCost+totalEquipmentCost; updateSetupDisplay({ totalSetupCost, totalRecruitmentCost, totalEquipmentCost, employeeCount, perWorkerCost }); document.getElementById('print-summary').innerHTML=generateSetupPrintHTML({ totalSetupCost, totalRecruitmentCost, totalEquipmentCost, employeeCount, perWorkerCost }); }
    function updateSetupDisplay(d){ document.getElementById('totalSetupCosts').textContent=formatCurrency(d.totalSetupCost); }
    function generateSetupPrintHTML(d){ return `<div class="mt-4"><h3 class="font-bold text-lg mb-2 text-center" style="font-size:1.1rem;">حاسبة تكاليف التأسيس</h3><table class="print-table"><tr><td>تكلفة التوظيف لكل موظفة</td><td>${formatCurrency(d.perWorkerCost)}</td></tr><tr><td>عدد الموظفات</td><td>${d.employeeCount}</td></tr><tr><td>إجمالي مصاريف الجلب</td><td>${formatCurrency(d.totalRecruitmentCost)}</td></tr><tr><td>إجمالي المعدات</td><td>${formatCurrency(d.totalEquipmentCost)}</td></tr><tr><td><strong>إجمالي تكاليف التأسيس</strong></td><td><strong>${formatCurrency(d.totalSetupCost)}</strong></td></tr></table></div>`; }

    // --- INIT ---
    function initialize(){
      document.getElementById('delivery-inputs').innerHTML=deliveryInputsHTML;
      document.getElementById('cleaning-inputs').innerHTML=cleaningInputsHTML;
      document.getElementById('setup-inputs').innerHTML=setupInputsHTML;
      document.querySelectorAll('input').forEach(input=>input.addEventListener('input',run));
      document.getElementById('btn-delivery').addEventListener('click',()=>switchCalculator('delivery'));
      document.getElementById('btn-cleaning').addEventListener('click',()=>switchCalculator('cleaning'));
      document.getElementById('btn-setup').addEventListener('click',()=>{ switchCalculator('setup'); if(document.querySelectorAll('#equipment-table-body tr').length===0){ for(let i=0;i<5;i++) addEquipmentRow(); } document.getElementById('add-row-btn')?.addEventListener('click', addEquipmentRow); });
      switchCalculator('delivery');
    }
    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>
